<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Details - Whiff & Wonder</title>
    <meta name="description" content="Discover this unique fragrance at Whiff & Wonder">
    <link rel="stylesheet" href="/css/styles.css">
    <script src="/js/translations.js"></script>
    <script src="/js/language-toggle.js"></script>
    <script src="/js/auth-check.js"></script>
    <script src="/js/product-loader.js"></script>
</head>
<body>
    <nav>   
        <button class="mobile-nav-toggle" onclick="toggleMobileNav()">‚ò∞</button>
        <div class="nav-links" id="mobileNav">
            <a href="/" data-translate="home">Home</a>
            <a href="/collection" data-translate="collections">Collections</a>
            <a href="/about" data-translate="aboutUs">About Us</a>
            <a href="/contact" data-translate="contact">Contact</a>
        </div>
        <div class="nav-controls">
            <button class="lang-toggle" onclick="toggleLanguage()">EN</button>
            <a href="/login" class="login-icon">üë§</a>
        </div>
    </nav>

    <div class="container">
        <div id="loadingMessage" class="loading-message">Loading product details...</div>
        <div id="errorMessage" class="error-message" style="display: none;"></div>
        
        <div id="productDetails" class="product-full" style="display: none;">
            <div class="product-left">
                <div class="product-image">
                    <img id="productImage" src="" alt="Product Image">
                </div>
            </div>
            <div class="product-right">
                <h1 id="productName"></h1>
                <button id="likeButton" class="like-button" onclick="toggleLike()">‚ù§Ô∏è</button>
                
                <div class="product-meta">
                    <div class="price-rating">
                        <div class="price">$<span id="productPrice"></span></div>
                        <div class="rating">
                            <span id="productStars" class="stars"></span>
                            <span id="productRating"></span>
                        </div>
                    </div>
                </div>

                <div class="accords-section">
                    <h3>Main Accords</h3>
                    <div id="productAccords" class="accords"></div>
                </div>

                <div class="notes-section">
                    <h3>Fragrance Notes</h3>
                    <div class="notes-pyramid">
                        <div class="note-group">
                            <h4>Top Notes</h4>
                            <p id="topNotes"></p>
                        </div>
                        <div class="note-group">
                            <h4>Heart Notes</h4>
                            <p id="heartNotes"></p>
                        </div>
                        <div class="note-group">
                            <h4>Base Notes</h4>
                            <p id="baseNotes"></p>
                        </div>
                    </div>
                </div>

                <div class="description-section">
                    <h3>Description</h3>
                    <p id="productDescription"></p>
                </div>

                <button id="addToCartBtn" class="add-to-cart-btn">Add to Cart</button>
            </div>
        </div>
    </div>

    <footer>
        <p>&copy; 2025 Whiff & Wonder. All Rights Reserved.</p>
    </footer>

    <script>
        async function loadProduct() {
            const urlParams = new URLSearchParams(window.location.search);
            const productId = urlParams.get('id');
            
            if (!productId) {
                showError('Product ID not specified');
                return;
            }

            try {
                const response = await fetch('items.json');
                if (!response.ok) {
                    throw new Error('Failed to fetch products');
                }

                const products = await response.json();
                const product = products.find(p => p.id === productId);

                if (!product) {
                    showError('Product not found');
                    return;
                }

                // Update product details
                document.title = `${product.name} - Whiff & Wonder`;
                document.getElementById('productName').textContent = product.name;
                document.getElementById('productImage').src = product.image;
                document.getElementById('productImage').alt = product.name;
                document.getElementById('productPrice').textContent = product.price.toFixed(2);
                document.getElementById('productRating').textContent = `${product.rating}/5`;
                
                // Generate stars based on rating
                const rating = Math.round(parseFloat(product.rating));
                document.getElementById('productStars').innerHTML = '‚òÖ'.repeat(rating) + '‚òÜ'.repeat(5 - rating);
                
                // Display accords
                const accordsHtml = product.accords
                    .map(accord => `<span class="accord">${accord}</span>`)
                    .join('');
                document.getElementById('productAccords').innerHTML = accordsHtml;
                
                // Display notes
                document.getElementById('topNotes').textContent = product.notes.top.join(', ');
                document.getElementById('heartNotes').textContent = product.notes.heart.join(', ');
                document.getElementById('baseNotes').textContent = product.notes.base.join(', ');
                
                document.getElementById('productDescription').textContent = product.description || '';

                // Show product details and hide loading message
                document.getElementById('loadingMessage').style.display = 'none';
                document.getElementById('productDetails').style.display = 'flex';

            } catch (error) {
                console.error('Error loading product:', error);
                showError('Error loading product details. Please try again later.');
            }
        }

        function showError(message) {
            document.getElementById('loadingMessage').style.display = 'none';
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function toggleMobileNav() {
            document.getElementById('mobileNav').classList.toggle('active');
        }

        async function toggleLike() {
            const urlParams = new URLSearchParams(window.location.search);
            const productId = urlParams.get('id');
            const likeButton = document.getElementById('likeButton');
            
            try {
                // Check authentication first
                const authResponse = await fetch('/api/verify-session');
                const authData = await authResponse.json();
                
                if (!authData.authenticated) {
                    window.location.href = '/login?redirect=' + encodeURIComponent(window.location.href);
                    return;
                }

                const response = await fetch('/api/user/likes', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        productId,
                        action: likeButton.classList.contains('liked') ? 'remove' : 'add'
                    }),
                    credentials: 'include'
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Failed to update like status');
                }

                const data = await response.json();
                if (data.success) {
                    likeButton.classList.toggle('liked');
                    // Update the button appearance
                    if (likeButton.classList.contains('liked')) {
                        likeButton.style.color = '#ff4d4d';
                        likeButton.style.transform = 'scale(1.1)';
                    } else {
                        likeButton.style.color = '';
                        likeButton.style.transform = '';
                    }
                }
            } catch (error) {
                console.error('Error updating like:', error);
                alert(error.message || 'Failed to update like status. Please try again.');
            }
        }

        async function addToRecentViews(productId) {
            try {
                const response = await fetch('/api/user/recent-views', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-user-id': 'anonymous' // In real app, get from session
                    },
                    body: JSON.stringify({ productId })
                });

                if (!response.ok) {
                    throw new Error('Failed to save recent view');
                }
            } catch (error) {
                console.warn('Error saving recent view:', error);
                // Non-critical error, don't show to user
            }
        }

        // Update like button state on load
        document.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const productId = urlParams.get('id');
            
            try {
                // Load product first
                await loadProduct();
                
                // Check if user is authenticated
                const authResponse = await fetch('/api/verify-session');
                const authData = await authResponse.json();
                
                if (authData.authenticated && productId) {
                    // Get user's likes
                    const likesResponse = await fetch('/api/user/likes', { 
                        credentials: 'include' 
                    });
                    
                    if (likesResponse.ok) {
                        const data = await likesResponse.json();
                        if (data.success && data.likes.includes(productId)) {
                            const likeButton = document.getElementById('likeButton');
                            likeButton.classList.add('liked');
                            likeButton.style.color = '#ff4d4d';
                        }
                    }
                    
                    // Add to recent views
                    addToRecentViews(productId).catch(console.error);
                }
            } catch (error) {
                console.error('Error loading product:', error);
                showError('Unable to load product details');
            }
        });
    </script>
</body>
</html>
